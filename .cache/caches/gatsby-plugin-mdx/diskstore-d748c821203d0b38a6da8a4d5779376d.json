{"expireTime":9007200836058614000,"key":"gatsby-plugin-mdx-entire-payload-941ff7c4d691deedc1a5e308af325c7c-","val":{"mdast":{"type":"root","children":[{"type":"paragraph","children":[{"type":"text","value":"Closures in Swift are a great feature and are useful for tasks such as network callbacks, notification subscription, and providing an alternative to the delegate pattern.","position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":171,"offset":171},"indent":[]}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":171,"offset":171},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Recently, I discovered that code as inconspicuous as a ","position":{"start":{"line":4,"column":1,"offset":173},"end":{"line":4,"column":56,"offset":228},"indent":[]}},{"type":"inlineCode","value":"&&","position":{"start":{"line":4,"column":56,"offset":228},"end":{"line":4,"column":60,"offset":232},"indent":[]}},{"type":"text","value":" (and) conditional could also leverage this feature.","position":{"start":{"line":4,"column":60,"offset":232},"end":{"line":4,"column":112,"offset":284},"indent":[]}}],"position":{"start":{"line":4,"column":1,"offset":173},"end":{"line":4,"column":112,"offset":284},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Let's assume that we are modelling a ","position":{"start":{"line":6,"column":1,"offset":286},"end":{"line":6,"column":38,"offset":323},"indent":[]}},{"type":"inlineCode","value":"User","position":{"start":{"line":6,"column":38,"offset":323},"end":{"line":6,"column":44,"offset":329},"indent":[]}},{"type":"text","value":" of a global subscription-based application where users can customize their theme color.","position":{"start":{"line":6,"column":44,"offset":329},"end":{"line":6,"column":132,"offset":417},"indent":[]}}],"position":{"start":{"line":6,"column":1,"offset":286},"end":{"line":6,"column":132,"offset":417},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"We could represent this in Swift as a struct that has properties for its: identifier, subscription status, country code, and theme color.\nThe resulting ","position":{"start":{"line":8,"column":1,"offset":419},"end":{"line":9,"column":15,"offset":571},"indent":[1]}},{"type":"inlineCode","value":"User","position":{"start":{"line":9,"column":15,"offset":571},"end":{"line":9,"column":21,"offset":577},"indent":[]}},{"type":"text","value":" model could look like this:","position":{"start":{"line":9,"column":21,"offset":577},"end":{"line":9,"column":49,"offset":605},"indent":[]}}],"position":{"start":{"line":8,"column":1,"offset":419},"end":{"line":9,"column":49,"offset":605},"indent":[1]}},{"type":"code","lang":"swift","meta":null,"value":"struct User {\n    var id: String\n    var isSubscribed: Bool\n    var themeColor: UIColor?\n    var countryCode: String\n}","position":{"start":{"line":10,"column":1,"offset":606},"end":{"line":17,"column":4,"offset":737},"indent":[1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"We'll make the ","position":{"start":{"line":19,"column":1,"offset":739},"end":{"line":19,"column":16,"offset":754},"indent":[]}},{"type":"inlineCode","value":"themeColor","position":{"start":{"line":19,"column":16,"offset":754},"end":{"line":19,"column":28,"offset":766},"indent":[]}},{"type":"text","value":" optional here since it'll be up to the User if they want to customize this.","position":{"start":{"line":19,"column":28,"offset":766},"end":{"line":19,"column":104,"offset":842},"indent":[]}}],"position":{"start":{"line":19,"column":1,"offset":739},"end":{"line":19,"column":104,"offset":842},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Assume that our application already had an object to represent a theme called ","position":{"start":{"line":21,"column":1,"offset":844},"end":{"line":21,"column":79,"offset":922},"indent":[]}},{"type":"inlineCode","value":"Theme","position":{"start":{"line":21,"column":79,"offset":922},"end":{"line":21,"column":86,"offset":929},"indent":[]}},{"type":"text","value":":","position":{"start":{"line":21,"column":86,"offset":929},"end":{"line":21,"column":87,"offset":930},"indent":[]}}],"position":{"start":{"line":21,"column":1,"offset":844},"end":{"line":21,"column":87,"offset":930},"indent":[]}},{"type":"code","lang":"swift","meta":null,"value":"class Theme {\n    let backgroundColor: UIColor\n\n    init(backgroundColor: UIColor?) {\n        self.backgroundColor = backgroundColor ?? .white\n    }\n}","position":{"start":{"line":23,"column":1,"offset":932},"end":{"line":31,"column":4,"offset":1095},"indent":[1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"Observe that this ","position":{"start":{"line":33,"column":1,"offset":1097},"end":{"line":33,"column":19,"offset":1115},"indent":[]}},{"type":"inlineCode","value":"init","position":{"start":{"line":33,"column":19,"offset":1115},"end":{"line":33,"column":25,"offset":1121},"indent":[]}},{"type":"text","value":" will fallback to ","position":{"start":{"line":33,"column":25,"offset":1121},"end":{"line":33,"column":43,"offset":1139},"indent":[]}},{"type":"inlineCode","value":"UIColor.white","position":{"start":{"line":33,"column":43,"offset":1139},"end":{"line":33,"column":58,"offset":1154},"indent":[]}},{"type":"text","value":" (or ","position":{"start":{"line":33,"column":58,"offset":1154},"end":{"line":33,"column":63,"offset":1159},"indent":[]}},{"type":"inlineCode","value":".white","position":{"start":{"line":33,"column":63,"offset":1159},"end":{"line":33,"column":71,"offset":1167},"indent":[]}},{"type":"text","value":") if the ","position":{"start":{"line":33,"column":71,"offset":1167},"end":{"line":33,"column":80,"offset":1176},"indent":[]}},{"type":"inlineCode","value":"backgroundColor","position":{"start":{"line":33,"column":80,"offset":1176},"end":{"line":33,"column":97,"offset":1193},"indent":[]}},{"type":"text","value":" property is ","position":{"start":{"line":33,"column":97,"offset":1193},"end":{"line":33,"column":110,"offset":1206},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"not","position":{"start":{"line":33,"column":112,"offset":1208},"end":{"line":33,"column":115,"offset":1211},"indent":[]}}],"position":{"start":{"line":33,"column":110,"offset":1206},"end":{"line":33,"column":117,"offset":1213},"indent":[]}},{"type":"text","value":" provided.","position":{"start":{"line":33,"column":117,"offset":1213},"end":{"line":33,"column":127,"offset":1223},"indent":[]}}],"position":{"start":{"line":33,"column":1,"offset":1097},"end":{"line":33,"column":127,"offset":1223},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Given this knowledge, we could create a new class just for the custom User theme.\nWe can initialize the custom theme with a User in order to grab its ","position":{"start":{"line":35,"column":1,"offset":1225},"end":{"line":36,"column":69,"offset":1375},"indent":[1]}},{"type":"inlineCode","value":"themeColor","position":{"start":{"line":36,"column":69,"offset":1375},"end":{"line":36,"column":81,"offset":1387},"indent":[]}},{"type":"text","value":". The theme color passes to its parent class as its ","position":{"start":{"line":36,"column":81,"offset":1387},"end":{"line":36,"column":133,"offset":1439},"indent":[]}},{"type":"inlineCode","value":"backgroundColor","position":{"start":{"line":36,"column":133,"offset":1439},"end":{"line":36,"column":150,"offset":1456},"indent":[]}},{"type":"text","value":".","position":{"start":{"line":36,"column":150,"offset":1456},"end":{"line":36,"column":151,"offset":1457},"indent":[]}}],"position":{"start":{"line":35,"column":1,"offset":1225},"end":{"line":36,"column":151,"offset":1457},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"A ","position":{"start":{"line":38,"column":1,"offset":1459},"end":{"line":38,"column":3,"offset":1461},"indent":[]}},{"type":"inlineCode","value":"Theme","position":{"start":{"line":38,"column":3,"offset":1461},"end":{"line":38,"column":10,"offset":1468},"indent":[]}},{"type":"text","value":" subclass can represent the custom User theme object:","position":{"start":{"line":38,"column":10,"offset":1468},"end":{"line":38,"column":63,"offset":1521},"indent":[]}}],"position":{"start":{"line":38,"column":1,"offset":1459},"end":{"line":38,"column":63,"offset":1521},"indent":[]}},{"type":"code","lang":"swift","meta":null,"value":"class UserTheme: Theme {\n    let user: User\n\n    init(user: User) {\n        self.user = user\n        super.init(backgroundColor: user.themeColor)\n    }\n}","position":{"start":{"line":39,"column":1,"offset":1522},"end":{"line":48,"column":4,"offset":1688},"indent":[1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"Let's assume that we have received additional requirements that limit User theming to:","position":{"start":{"line":50,"column":1,"offset":1690},"end":{"line":50,"column":87,"offset":1776},"indent":[]}}],"position":{"start":{"line":50,"column":1,"offset":1690},"end":{"line":50,"column":87,"offset":1776},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"subscription users","position":{"start":{"line":51,"column":3,"offset":1779},"end":{"line":51,"column":21,"offset":1797},"indent":[]}}],"position":{"start":{"line":51,"column":3,"offset":1779},"end":{"line":51,"column":21,"offset":1797},"indent":[]}}],"position":{"start":{"line":51,"column":1,"offset":1777},"end":{"line":51,"column":21,"offset":1797},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Canadian users","position":{"start":{"line":52,"column":3,"offset":1800},"end":{"line":52,"column":17,"offset":1814},"indent":[]}}],"position":{"start":{"line":52,"column":3,"offset":1800},"end":{"line":52,"column":17,"offset":1814},"indent":[]}}],"position":{"start":{"line":52,"column":1,"offset":1798},"end":{"line":52,"column":17,"offset":1814},"indent":[]}}],"position":{"start":{"line":51,"column":1,"offset":1777},"end":{"line":52,"column":17,"offset":1814},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"We could then update our ","position":{"start":{"line":54,"column":1,"offset":1816},"end":{"line":54,"column":26,"offset":1841},"indent":[]}},{"type":"inlineCode","value":"init","position":{"start":{"line":54,"column":26,"offset":1841},"end":{"line":54,"column":32,"offset":1847},"indent":[]}},{"type":"text","value":" method on ","position":{"start":{"line":54,"column":32,"offset":1847},"end":{"line":54,"column":43,"offset":1858},"indent":[]}},{"type":"inlineCode","value":"UserTheme","position":{"start":{"line":54,"column":43,"offset":1858},"end":{"line":54,"column":54,"offset":1869},"indent":[]}},{"type":"text","value":" to handle these cases as follows:","position":{"start":{"line":54,"column":54,"offset":1869},"end":{"line":54,"column":88,"offset":1903},"indent":[]}}],"position":{"start":{"line":54,"column":1,"offset":1816},"end":{"line":54,"column":88,"offset":1903},"indent":[]}},{"type":"code","lang":"swift","meta":null,"value":"var themeColor: UIColor?\nif self.user.isSubscribed && self.user.countryCode == \"CA\" {\n    themeColor = self.user.themeColor\n}\nsuper.init(backgroundColor: themeColor)","position":{"start":{"line":55,"column":1,"offset":1904},"end":{"line":61,"column":4,"offset":2082},"indent":[1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"Although this looks alright, it'll actually fail to compile. You'll see the following error log in Xcode:","position":{"start":{"line":63,"column":1,"offset":2084},"end":{"line":63,"column":106,"offset":2189},"indent":[]}}],"position":{"start":{"line":63,"column":1,"offset":2084},"end":{"line":63,"column":106,"offset":2189},"indent":[]}},{"type":"code","lang":null,"meta":null,"value":"error: 'self' captured by a closure before all members were initialized\n        if self.user.isSubscribed && self.user.countryCode == \"CA\" {\n                                     ^","position":{"start":{"line":64,"column":1,"offset":2190},"end":{"line":68,"column":4,"offset":2377},"indent":[1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"This error message while informative is a bit confusing. What closure is it referencing?","position":{"start":{"line":70,"column":1,"offset":2379},"end":{"line":70,"column":89,"offset":2467},"indent":[]}}],"position":{"start":{"line":70,"column":1,"offset":2379},"end":{"line":70,"column":89,"offset":2467},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"We could easily fix by removing the explicit ","position":{"start":{"line":72,"column":1,"offset":2469},"end":{"line":72,"column":46,"offset":2514},"indent":[]}},{"type":"inlineCode","value":"self","position":{"start":{"line":72,"column":46,"offset":2514},"end":{"line":72,"column":52,"offset":2520},"indent":[]}},{"type":"text","value":" and instead rely on the ","position":{"start":{"line":72,"column":52,"offset":2520},"end":{"line":72,"column":77,"offset":2545},"indent":[]}},{"type":"inlineCode","value":"user","position":{"start":{"line":72,"column":77,"offset":2545},"end":{"line":72,"column":83,"offset":2551},"indent":[]}},{"type":"text","value":" property passed in as a parameter. This fixes the symptom and not the root cause which is that there is an implicit closure in this line of code?","position":{"start":{"line":72,"column":83,"offset":2551},"end":{"line":72,"column":229,"offset":2697},"indent":[]}}],"position":{"start":{"line":72,"column":1,"offset":2469},"end":{"line":72,"column":229,"offset":2697},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"After posting this error message to the ","position":{"start":{"line":74,"column":1,"offset":2699},"end":{"line":74,"column":41,"offset":2739},"indent":[]}},{"type":"link","title":null,"url":"https://www.meetup.com/tacow-org/","children":[{"type":"text","value":"tacow","position":{"start":{"line":74,"column":42,"offset":2740},"end":{"line":74,"column":47,"offset":2745},"indent":[]}}],"position":{"start":{"line":74,"column":41,"offset":2739},"end":{"line":74,"column":83,"offset":2781},"indent":[]}},{"type":"text","value":" Slack group, ","position":{"start":{"line":74,"column":83,"offset":2781},"end":{"line":74,"column":97,"offset":2795},"indent":[]}},{"type":"link","title":null,"url":"https://twitter.com/rydermackay","children":[{"type":"text","value":"@rydermackay","position":{"start":{"line":74,"column":98,"offset":2796},"end":{"line":74,"column":110,"offset":2808},"indent":[]}}],"position":{"start":{"line":74,"column":97,"offset":2795},"end":{"line":74,"column":144,"offset":2842},"indent":[]}},{"type":"text","value":" pointed out to me that the Swift language is capturing the right-hand side of the conditional in a closure.","position":{"start":{"line":74,"column":144,"offset":2842},"end":{"line":74,"column":252,"offset":2950},"indent":[]}}],"position":{"start":{"line":74,"column":1,"offset":2699},"end":{"line":74,"column":252,"offset":2950},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"That is, given the conditional: ","position":{"start":{"line":76,"column":1,"offset":2952},"end":{"line":76,"column":33,"offset":2984},"indent":[]}},{"type":"inlineCode","value":"lhs && rhs","position":{"start":{"line":76,"column":33,"offset":2984},"end":{"line":76,"column":45,"offset":2996},"indent":[]}},{"type":"text","value":" (\"lhs\" and \"rhs\" represent Left-Hand Side and Right-Hand Side respectively). ","position":{"start":{"line":76,"column":45,"offset":2996},"end":{"line":76,"column":123,"offset":3074},"indent":[]}},{"type":"inlineCode","value":"rhs","position":{"start":{"line":76,"column":123,"offset":3074},"end":{"line":76,"column":128,"offset":3079},"indent":[]}},{"type":"text","value":" is being wrapped in a closure. More specifically, it is wrapped in an ","position":{"start":{"line":76,"column":128,"offset":3079},"end":{"line":76,"column":199,"offset":3150},"indent":[]}},{"type":"inlineCode","value":"autoclosure","position":{"start":{"line":76,"column":199,"offset":3150},"end":{"line":76,"column":212,"offset":3163},"indent":[]}},{"type":"text","value":" so that it could lazily evaluate the right condition if the left condition was false.","position":{"start":{"line":76,"column":212,"offset":3163},"end":{"line":76,"column":298,"offset":3249},"indent":[]}}],"position":{"start":{"line":76,"column":1,"offset":2952},"end":{"line":76,"column":298,"offset":3249},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"This can be shown by looking at the source code for the ","position":{"start":{"line":78,"column":1,"offset":3251},"end":{"line":78,"column":57,"offset":3307},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/apple/swift/blob/7f105e4e3a994e6ac87860d5bd7bf9942c52b4bb/stdlib/public/core/Bool.swift#L289","children":[{"type":"text","value":"&& operator","position":{"start":{"line":78,"column":58,"offset":3308},"end":{"line":78,"column":69,"offset":3319},"indent":[]}}],"position":{"start":{"line":78,"column":57,"offset":3307},"end":{"line":78,"column":183,"offset":3433},"indent":[]}},{"type":"text","value":":","position":{"start":{"line":78,"column":183,"offset":3433},"end":{"line":78,"column":184,"offset":3434},"indent":[]}}],"position":{"start":{"line":78,"column":1,"offset":3251},"end":{"line":78,"column":184,"offset":3434},"indent":[]}},{"type":"code","lang":"swift","meta":null,"value":"public static func && (lhs: Bool, rhs: @autoclosure () throws -> Bool) rethrows -> Bool {\n    return lhs ? try rhs() : false\n}","position":{"start":{"line":79,"column":1,"offset":3435},"end":{"line":83,"column":4,"offset":3574},"indent":[1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"In order to understand the warning a little better, we need to know what an ","position":{"start":{"line":85,"column":1,"offset":3576},"end":{"line":85,"column":77,"offset":3652},"indent":[]}},{"type":"inlineCode","value":"autoclosure","position":{"start":{"line":85,"column":77,"offset":3652},"end":{"line":85,"column":90,"offset":3665},"indent":[]}},{"type":"text","value":" is.","position":{"start":{"line":85,"column":90,"offset":3665},"end":{"line":85,"column":94,"offset":3669},"indent":[]}}],"position":{"start":{"line":85,"column":1,"offset":3576},"end":{"line":85,"column":94,"offset":3669},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"From the Apple documentation, an ","position":{"start":{"line":87,"column":1,"offset":3671},"end":{"line":87,"column":34,"offset":3704},"indent":[]}},{"type":"inlineCode","value":"autoclosure","position":{"start":{"line":87,"column":34,"offset":3704},"end":{"line":87,"column":47,"offset":3717},"indent":[]}},{"type":"text","value":":","position":{"start":{"line":87,"column":47,"offset":3717},"end":{"line":87,"column":48,"offset":3718},"indent":[]}}],"position":{"start":{"line":87,"column":1,"offset":3671},"end":{"line":87,"column":48,"offset":3718},"indent":[]}},{"type":"blockquote","children":[{"type":"paragraph","children":[{"type":"text","value":"...is a closure that is automatically created to wrap an expression that’s being passed as an argument to a function. It doesn’t take any arguments, and when it’s called, it returns the value of the expression that’s wrapped inside of it.","position":{"start":{"line":89,"column":3,"offset":3722},"end":{"line":89,"column":241,"offset":3960},"indent":[]}}],"position":{"start":{"line":89,"column":3,"offset":3722},"end":{"line":89,"column":241,"offset":3960},"indent":[]}}],"position":{"start":{"line":89,"column":1,"offset":3720},"end":{"line":89,"column":241,"offset":3960},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"but most importantly:","position":{"start":{"line":91,"column":1,"offset":3962},"end":{"line":91,"column":22,"offset":3983},"indent":[]}}],"position":{"start":{"line":91,"column":1,"offset":3962},"end":{"line":91,"column":22,"offset":3983},"indent":[]}},{"type":"blockquote","children":[{"type":"paragraph","children":[{"type":"text","value":"An autoclosure lets you delay evaluation because the code inside isn’t run until you call the closure. Delaying evaluation is useful for code that has side effects or is computationally expensive because it lets you control when that code is evaluated.","position":{"start":{"line":93,"column":3,"offset":3987},"end":{"line":93,"column":255,"offset":4239},"indent":[]}}],"position":{"start":{"line":93,"column":3,"offset":3987},"end":{"line":93,"column":255,"offset":4239},"indent":[]}}],"position":{"start":{"line":93,"column":1,"offset":3985},"end":{"line":93,"column":255,"offset":4239},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"That means that the above ","position":{"start":{"line":96,"column":1,"offset":4242},"end":{"line":96,"column":27,"offset":4268},"indent":[]}},{"type":"inlineCode","value":"&&","position":{"start":{"line":96,"column":27,"offset":4268},"end":{"line":96,"column":31,"offset":4272},"indent":[]}},{"type":"text","value":" implementation at a high level is equivalent to the following. Note: We can't actually write ","position":{"start":{"line":96,"column":31,"offset":4272},"end":{"line":96,"column":125,"offset":4366},"indent":[]}},{"type":"inlineCode","value":"&&","position":{"start":{"line":96,"column":125,"offset":4366},"end":{"line":96,"column":129,"offset":4370},"indent":[]}},{"type":"text","value":" without the ","position":{"start":{"line":96,"column":129,"offset":4370},"end":{"line":96,"column":142,"offset":4383},"indent":[]}},{"type":"inlineCode","value":"rhs","position":{"start":{"line":96,"column":142,"offset":4383},"end":{"line":96,"column":147,"offset":4388},"indent":[]}},{"type":"text","value":" since it's defined to have both parameters.","position":{"start":{"line":96,"column":147,"offset":4388},"end":{"line":96,"column":191,"offset":4432},"indent":[]}}],"position":{"start":{"line":96,"column":1,"offset":4242},"end":{"line":96,"column":191,"offset":4432},"indent":[]}},{"type":"code","lang":"swift","meta":null,"value":"// For simplicity, I've removed all throws\npublic static func && (lhs: Bool, rhs: () -> Bool) -> Bool {\n    return lhs ?? rhs()\n}\n\n// Example: Assume A and B are some boolean conditions\nA && { () -> Bool in\n    return B\n}","position":{"start":{"line":98,"column":1,"offset":4434},"end":{"line":108,"column":4,"offset":4668},"indent":[1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"If we update our previous ","position":{"start":{"line":110,"column":1,"offset":4670},"end":{"line":110,"column":27,"offset":4696},"indent":[]}},{"type":"inlineCode","value":"UserTheme","position":{"start":{"line":110,"column":27,"offset":4696},"end":{"line":110,"column":38,"offset":4707},"indent":[]}},{"type":"text","value":" ","position":{"start":{"line":110,"column":38,"offset":4707},"end":{"line":110,"column":39,"offset":4708},"indent":[]}},{"type":"inlineCode","value":"init","position":{"start":{"line":110,"column":39,"offset":4708},"end":{"line":110,"column":45,"offset":4714},"indent":[]}},{"type":"text","value":" with this re-interpretation, it would look like this","position":{"start":{"line":110,"column":45,"offset":4714},"end":{"line":110,"column":98,"offset":4767},"indent":[]}}],"position":{"start":{"line":110,"column":1,"offset":4670},"end":{"line":110,"column":98,"offset":4767},"indent":[]}},{"type":"code","lang":"swift","meta":null,"value":"let result = self.user.isSubscribed && { () -> Bool in\n    return self.user.countryCode == \"CA\"\n}\nif result {\n    themeColor = self.user.themeColor\n}","position":{"start":{"line":112,"column":1,"offset":4769},"end":{"line":119,"column":4,"offset":4931},"indent":[1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"As you can see, the block captures ","position":{"start":{"line":121,"column":1,"offset":4933},"end":{"line":121,"column":36,"offset":4968},"indent":[]}},{"type":"inlineCode","value":"self.user.countryCode == \"CA\"","position":{"start":{"line":121,"column":36,"offset":4968},"end":{"line":121,"column":67,"offset":4999},"indent":[]}},{"type":"text","value":" and since we're doing this before ","position":{"start":{"line":121,"column":67,"offset":4999},"end":{"line":121,"column":102,"offset":5034},"indent":[]}},{"type":"inlineCode","value":"super.init()","position":{"start":{"line":121,"column":102,"offset":5034},"end":{"line":121,"column":116,"offset":5048},"indent":[]}},{"type":"text","value":" when all members have initialized the compilation fails.","position":{"start":{"line":121,"column":116,"offset":5048},"end":{"line":121,"column":173,"offset":5105},"indent":[]}}],"position":{"start":{"line":121,"column":1,"offset":4933},"end":{"line":121,"column":173,"offset":5105},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"There are a few ways to fix this, we could:","position":{"start":{"line":123,"column":1,"offset":5107},"end":{"line":123,"column":44,"offset":5150},"indent":[]}}],"position":{"start":{"line":123,"column":1,"offset":5107},"end":{"line":123,"column":44,"offset":5150},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"move all this offending code to below the ","position":{"start":{"line":124,"column":3,"offset":5153},"end":{"line":124,"column":45,"offset":5195},"indent":[]}},{"type":"inlineCode","value":"super.init()","position":{"start":{"line":124,"column":45,"offset":5195},"end":{"line":124,"column":59,"offset":5209},"indent":[]}}],"position":{"start":{"line":124,"column":3,"offset":5153},"end":{"line":124,"column":59,"offset":5209},"indent":[]}}],"position":{"start":{"line":124,"column":1,"offset":5151},"end":{"line":124,"column":59,"offset":5209},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"store the result of the right-hand side expression in a separate variable, or;","position":{"start":{"line":125,"column":3,"offset":5212},"end":{"line":125,"column":81,"offset":5290},"indent":[]}}],"position":{"start":{"line":125,"column":3,"offset":5212},"end":{"line":125,"column":81,"offset":5290},"indent":[]}}],"position":{"start":{"line":125,"column":1,"offset":5210},"end":{"line":125,"column":81,"offset":5290},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"we could move the creation of Themes to a ","position":{"start":{"line":126,"column":3,"offset":5293},"end":{"line":126,"column":45,"offset":5335},"indent":[]}},{"type":"link","title":null,"url":"https://en.wikipedia.org/wiki/Factory_method_pattern","children":[{"type":"text","value":"factory","position":{"start":{"line":126,"column":46,"offset":5336},"end":{"line":126,"column":53,"offset":5343},"indent":[]}}],"position":{"start":{"line":126,"column":45,"offset":5335},"end":{"line":126,"column":108,"offset":5398},"indent":[]}},{"type":"text","value":" class to avoid a ","position":{"start":{"line":126,"column":108,"offset":5398},"end":{"line":126,"column":126,"offset":5416},"indent":[]}},{"type":"inlineCode","value":"Theme","position":{"start":{"line":126,"column":126,"offset":5416},"end":{"line":126,"column":133,"offset":5423},"indent":[]}},{"type":"text","value":" subclass","position":{"start":{"line":126,"column":133,"offset":5423},"end":{"line":126,"column":142,"offset":5432},"indent":[]}}],"position":{"start":{"line":126,"column":3,"offset":5293},"end":{"line":126,"column":142,"offset":5432},"indent":[]}}],"position":{"start":{"line":126,"column":1,"offset":5291},"end":{"line":126,"column":142,"offset":5432},"indent":[]}}],"position":{"start":{"line":124,"column":1,"offset":5151},"end":{"line":126,"column":142,"offset":5432},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"Either way, these all work but in general you should typically avoid referencing ","position":{"start":{"line":128,"column":1,"offset":5434},"end":{"line":128,"column":82,"offset":5515},"indent":[]}},{"type":"inlineCode","value":"self","position":{"start":{"line":128,"column":82,"offset":5515},"end":{"line":128,"column":88,"offset":5521},"indent":[]}},{"type":"text","value":" before the ","position":{"start":{"line":128,"column":88,"offset":5521},"end":{"line":128,"column":100,"offset":5533},"indent":[]}},{"type":"inlineCode","value":"super.init()","position":{"start":{"line":128,"column":100,"offset":5533},"end":{"line":128,"column":114,"offset":5547},"indent":[]}},{"type":"text","value":" in cases like these.\nI hope you learned something and potentially got you interested in looking at more implementation details of the Swift programming language.","position":{"start":{"line":128,"column":114,"offset":5547},"end":{"line":129,"column":141,"offset":5709},"indent":[1]}}],"position":{"start":{"line":128,"column":1,"offset":5434},"end":{"line":129,"column":141,"offset":5709},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"The sample code can be found ","position":{"start":{"line":131,"column":1,"offset":5711},"end":{"line":131,"column":30,"offset":5740},"indent":[]}},{"type":"link","title":null,"url":"https://github.com/ajfigueroa/blog-code/tree/master/posts/3-Unexpected-Closure.playground","children":[{"type":"text","value":"here","position":{"start":{"line":131,"column":31,"offset":5741},"end":{"line":131,"column":35,"offset":5745},"indent":[]}}],"position":{"start":{"line":131,"column":30,"offset":5740},"end":{"line":131,"column":127,"offset":5837},"indent":[]}},{"type":"text","value":".","position":{"start":{"line":131,"column":127,"offset":5837},"end":{"line":131,"column":128,"offset":5838},"indent":[]}}],"position":{"start":{"line":131,"column":1,"offset":5711},"end":{"line":131,"column":128,"offset":5838},"indent":[]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"Additional Resources","position":{"start":{"line":133,"column":4,"offset":5843},"end":{"line":133,"column":24,"offset":5863},"indent":[]}}],"position":{"start":{"line":133,"column":1,"offset":5840},"end":{"line":133,"column":24,"offset":5863},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"link","title":null,"url":"https://docs.swift.org/swift-book/LanguageGuide/Closures.html#ID543","children":[{"type":"text","value":"Autoclosure Documentation","position":{"start":{"line":135,"column":4,"offset":5868},"end":{"line":135,"column":29,"offset":5893},"indent":[]}}],"position":{"start":{"line":135,"column":3,"offset":5867},"end":{"line":135,"column":99,"offset":5963},"indent":[]}}],"position":{"start":{"line":135,"column":3,"offset":5867},"end":{"line":135,"column":99,"offset":5963},"indent":[]}}],"position":{"start":{"line":135,"column":1,"offset":5865},"end":{"line":135,"column":99,"offset":5963},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"link","title":null,"url":"https://krakendev.io/blog/hipster-swift#autoclosure","children":[{"type":"text","value":"Hipster Swift post by KrakenDev","position":{"start":{"line":136,"column":4,"offset":5967},"end":{"line":136,"column":35,"offset":5998},"indent":[]}}],"position":{"start":{"line":136,"column":3,"offset":5966},"end":{"line":136,"column":89,"offset":6052},"indent":[]}}],"position":{"start":{"line":136,"column":3,"offset":5966},"end":{"line":136,"column":89,"offset":6052},"indent":[]}}],"position":{"start":{"line":136,"column":1,"offset":5964},"end":{"line":136,"column":89,"offset":6052},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"link","title":null,"url":"https://github.com/apple/swift","children":[{"type":"text","value":"Swift Repo","position":{"start":{"line":137,"column":4,"offset":6056},"end":{"line":137,"column":14,"offset":6066},"indent":[]}}],"position":{"start":{"line":137,"column":3,"offset":6055},"end":{"line":137,"column":47,"offset":6099},"indent":[]}}],"position":{"start":{"line":137,"column":3,"offset":6055},"end":{"line":137,"column":47,"offset":6099},"indent":[]}}],"position":{"start":{"line":137,"column":1,"offset":6053},"end":{"line":137,"column":47,"offset":6099},"indent":[]}}],"position":{"start":{"line":135,"column":1,"offset":5865},"end":{"line":137,"column":47,"offset":6099},"indent":[1,1]}},{"type":"export","value":"export const _frontmatter = {\"title\":\"Unexpected Closure\",\"date\":\"2018-09-04T00:00:00.000Z\"}","position":{"start":{"line":140,"column":1,"offset":6102},"end":{"line":140,"column":93,"offset":6194},"indent":[]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":140,"column":93,"offset":6194}}},"scopeImports":["import React from 'react'"],"scopeIdentifiers":["React"],"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Unexpected Closure\",\n  \"date\": \"2018-09-04T00:00:00.000Z\"\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Closures in Swift are a great feature and are useful for tasks such as network callbacks, notification subscription, and providing an alternative to the delegate pattern.\"), mdx(\"p\", null, \"Recently, I discovered that code as inconspicuous as a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"&&\"), \" (and) conditional could also leverage this feature.\"), mdx(\"p\", null, \"Let\\u2019s assume that we are modelling a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"User\"), \" of a global subscription-based application where users can customize their theme color.\"), mdx(\"p\", null, \"We could represent this in Swift as a struct that has properties for its: identifier, subscription status, country code, and theme color.\\nThe resulting \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"User\"), \" model could look like this:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-swift\"\n  }), \"struct User {\\n    var id: String\\n    var isSubscribed: Bool\\n    var themeColor: UIColor?\\n    var countryCode: String\\n}\\n\")), mdx(\"p\", null, \"We\\u2019ll make the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"themeColor\"), \" optional here since it\\u2019ll be up to the User if they want to customize this.\"), mdx(\"p\", null, \"Assume that our application already had an object to represent a theme called \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Theme\"), \":\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-swift\"\n  }), \"class Theme {\\n    let backgroundColor: UIColor\\n\\n    init(backgroundColor: UIColor?) {\\n        self.backgroundColor = backgroundColor ?? .white\\n    }\\n}\\n\")), mdx(\"p\", null, \"Observe that this \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"init\"), \" will fallback to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"UIColor.white\"), \" (or \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \".white\"), \") if the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"backgroundColor\"), \" property is \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"not\"), \" provided.\"), mdx(\"p\", null, \"Given this knowledge, we could create a new class just for the custom User theme.\\nWe can initialize the custom theme with a User in order to grab its \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"themeColor\"), \". The theme color passes to its parent class as its \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"backgroundColor\"), \".\"), mdx(\"p\", null, \"A \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Theme\"), \" subclass can represent the custom User theme object:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-swift\"\n  }), \"class UserTheme: Theme {\\n    let user: User\\n\\n    init(user: User) {\\n        self.user = user\\n        super.init(backgroundColor: user.themeColor)\\n    }\\n}\\n\")), mdx(\"p\", null, \"Let\\u2019s assume that we have received additional requirements that limit User theming to:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"subscription users\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Canadian users\")), mdx(\"p\", null, \"We could then update our \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"init\"), \" method on \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"UserTheme\"), \" to handle these cases as follows:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-swift\"\n  }), \"var themeColor: UIColor?\\nif self.user.isSubscribed && self.user.countryCode == \\\"CA\\\" {\\n    themeColor = self.user.themeColor\\n}\\nsuper.init(backgroundColor: themeColor)\\n\")), mdx(\"p\", null, \"Although this looks alright, it\\u2019ll actually fail to compile. You\\u2019ll see the following error log in Xcode:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {}), \"error: 'self' captured by a closure before all members were initialized\\n        if self.user.isSubscribed && self.user.countryCode == \\\"CA\\\" {\\n                                     ^\\n\")), mdx(\"p\", null, \"This error message while informative is a bit confusing. What closure is it referencing?\"), mdx(\"p\", null, \"We could easily fix by removing the explicit \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"self\"), \" and instead rely on the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"user\"), \" property passed in as a parameter. This fixes the symptom and not the root cause which is that there is an implicit closure in this line of code?\"), mdx(\"p\", null, \"After posting this error message to the \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://www.meetup.com/tacow-org/\"\n  }), \"tacow\"), \" Slack group, \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://twitter.com/rydermackay\"\n  }), \"@rydermackay\"), \" pointed out to me that the Swift language is capturing the right-hand side of the conditional in a closure.\"), mdx(\"p\", null, \"That is, given the conditional: \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"lhs && rhs\"), \" (\\u201Clhs\\u201D and \\u201Crhs\\u201D represent Left-Hand Side and Right-Hand Side respectively). \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"rhs\"), \" is being wrapped in a closure. More specifically, it is wrapped in an \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"autoclosure\"), \" so that it could lazily evaluate the right condition if the left condition was false.\"), mdx(\"p\", null, \"This can be shown by looking at the source code for the \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/apple/swift/blob/7f105e4e3a994e6ac87860d5bd7bf9942c52b4bb/stdlib/public/core/Bool.swift#L289\"\n  }), \"&& operator\"), \":\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-swift\"\n  }), \"public static func && (lhs: Bool, rhs: @autoclosure () throws -> Bool) rethrows -> Bool {\\n    return lhs ? try rhs() : false\\n}\\n\")), mdx(\"p\", null, \"In order to understand the warning a little better, we need to know what an \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"autoclosure\"), \" is.\"), mdx(\"p\", null, \"From the Apple documentation, an \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"autoclosure\"), \":\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"\\u2026is a closure that is automatically created to wrap an expression that\\u2019s being passed as an argument to a function. It doesn\\u2019t take any arguments, and when it\\u2019s called, it returns the value of the expression that\\u2019s wrapped inside of it.\")), mdx(\"p\", null, \"but most importantly:\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"An autoclosure lets you delay evaluation because the code inside isn\\u2019t run until you call the closure. Delaying evaluation is useful for code that has side effects or is computationally expensive because it lets you control when that code is evaluated.\")), mdx(\"p\", null, \"That means that the above \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"&&\"), \" implementation at a high level is equivalent to the following. Note: We can\\u2019t actually write \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"&&\"), \" without the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"rhs\"), \" since it\\u2019s defined to have both parameters.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-swift\"\n  }), \"// For simplicity, I've removed all throws\\npublic static func && (lhs: Bool, rhs: () -> Bool) -> Bool {\\n    return lhs ?? rhs()\\n}\\n\\n// Example: Assume A and B are some boolean conditions\\nA && { () -> Bool in\\n    return B\\n}\\n\")), mdx(\"p\", null, \"If we update our previous \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"UserTheme\"), \" \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"init\"), \" with this re-interpretation, it would look like this\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-swift\"\n  }), \"let result = self.user.isSubscribed && { () -> Bool in\\n    return self.user.countryCode == \\\"CA\\\"\\n}\\nif result {\\n    themeColor = self.user.themeColor\\n}\\n\")), mdx(\"p\", null, \"As you can see, the block captures \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"self.user.countryCode == \\\"CA\\\"\"), \" and since we\\u2019re doing this before \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"super.init()\"), \" when all members have initialized the compilation fails.\"), mdx(\"p\", null, \"There are a few ways to fix this, we could:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"move all this offending code to below the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"super.init()\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"store the result of the right-hand side expression in a separate variable, or;\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"we could move the creation of Themes to a \", mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://en.wikipedia.org/wiki/Factory_method_pattern\"\n  }), \"factory\"), \" class to avoid a \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Theme\"), \" subclass\")), mdx(\"p\", null, \"Either way, these all work but in general you should typically avoid referencing \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"self\"), \" before the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"super.init()\"), \" in cases like these.\\nI hope you learned something and potentially got you interested in looking at more implementation details of the Swift programming language.\"), mdx(\"p\", null, \"The sample code can be found \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/ajfigueroa/blog-code/tree/master/posts/3-Unexpected-Closure.playground\"\n  }), \"here\"), \".\"), mdx(\"h2\", {\n    \"id\": \"additional-resources\"\n  }, \"Additional Resources\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://docs.swift.org/swift-book/LanguageGuide/Closures.html#ID543\"\n  }), \"Autoclosure Documentation\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://krakendev.io/blog/hipster-swift#autoclosure\"\n  }), \"Hipster Swift post by KrakenDev\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://github.com/apple/swift\"\n  }), \"Swift Repo\"))));\n}\n;\nMDXContent.isMDXComponent = true;","rawMDXOutput":"/* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsx mdx */\n\nexport const _frontmatter = {\n  \"title\": \"Unexpected Closure\",\n  \"date\": \"2018-09-04T00:00:00.000Z\"\n};\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\")\n  return <div {...props}/>\n};\n\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = \"wrapper\"\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n    <p>{`Closures in Swift are a great feature and are useful for tasks such as network callbacks, notification subscription, and providing an alternative to the delegate pattern.`}</p>\n    <p>{`Recently, I discovered that code as inconspicuous as a `}<inlineCode parentName=\"p\">{`&&`}</inlineCode>{` (and) conditional could also leverage this feature.`}</p>\n    <p>{`Let’s assume that we are modelling a `}<inlineCode parentName=\"p\">{`User`}</inlineCode>{` of a global subscription-based application where users can customize their theme color.`}</p>\n    <p>{`We could represent this in Swift as a struct that has properties for its: identifier, subscription status, country code, and theme color.\nThe resulting `}<inlineCode parentName=\"p\">{`User`}</inlineCode>{` model could look like this:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-swift\"\n      }}>{`struct User {\n    var id: String\n    var isSubscribed: Bool\n    var themeColor: UIColor?\n    var countryCode: String\n}\n`}</code></pre>\n    <p>{`We’ll make the `}<inlineCode parentName=\"p\">{`themeColor`}</inlineCode>{` optional here since it’ll be up to the User if they want to customize this.`}</p>\n    <p>{`Assume that our application already had an object to represent a theme called `}<inlineCode parentName=\"p\">{`Theme`}</inlineCode>{`:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-swift\"\n      }}>{`class Theme {\n    let backgroundColor: UIColor\n\n    init(backgroundColor: UIColor?) {\n        self.backgroundColor = backgroundColor ?? .white\n    }\n}\n`}</code></pre>\n    <p>{`Observe that this `}<inlineCode parentName=\"p\">{`init`}</inlineCode>{` will fallback to `}<inlineCode parentName=\"p\">{`UIColor.white`}</inlineCode>{` (or `}<inlineCode parentName=\"p\">{`.white`}</inlineCode>{`) if the `}<inlineCode parentName=\"p\">{`backgroundColor`}</inlineCode>{` property is `}<strong parentName=\"p\">{`not`}</strong>{` provided.`}</p>\n    <p>{`Given this knowledge, we could create a new class just for the custom User theme.\nWe can initialize the custom theme with a User in order to grab its `}<inlineCode parentName=\"p\">{`themeColor`}</inlineCode>{`. The theme color passes to its parent class as its `}<inlineCode parentName=\"p\">{`backgroundColor`}</inlineCode>{`.`}</p>\n    <p>{`A `}<inlineCode parentName=\"p\">{`Theme`}</inlineCode>{` subclass can represent the custom User theme object:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-swift\"\n      }}>{`class UserTheme: Theme {\n    let user: User\n\n    init(user: User) {\n        self.user = user\n        super.init(backgroundColor: user.themeColor)\n    }\n}\n`}</code></pre>\n    <p>{`Let’s assume that we have received additional requirements that limit User theming to:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`subscription users`}</li>\n      <li parentName=\"ul\">{`Canadian users`}</li>\n    </ul>\n    <p>{`We could then update our `}<inlineCode parentName=\"p\">{`init`}</inlineCode>{` method on `}<inlineCode parentName=\"p\">{`UserTheme`}</inlineCode>{` to handle these cases as follows:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-swift\"\n      }}>{`var themeColor: UIColor?\nif self.user.isSubscribed && self.user.countryCode == \"CA\" {\n    themeColor = self.user.themeColor\n}\nsuper.init(backgroundColor: themeColor)\n`}</code></pre>\n    <p>{`Although this looks alright, it’ll actually fail to compile. You’ll see the following error log in Xcode:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`error: 'self' captured by a closure before all members were initialized\n        if self.user.isSubscribed && self.user.countryCode == \"CA\" {\n                                     ^\n`}</code></pre>\n    <p>{`This error message while informative is a bit confusing. What closure is it referencing?`}</p>\n    <p>{`We could easily fix by removing the explicit `}<inlineCode parentName=\"p\">{`self`}</inlineCode>{` and instead rely on the `}<inlineCode parentName=\"p\">{`user`}</inlineCode>{` property passed in as a parameter. This fixes the symptom and not the root cause which is that there is an implicit closure in this line of code?`}</p>\n    <p>{`After posting this error message to the `}<a parentName=\"p\" {...{\n        \"href\": \"https://www.meetup.com/tacow-org/\"\n      }}>{`tacow`}</a>{` Slack group, `}<a parentName=\"p\" {...{\n        \"href\": \"https://twitter.com/rydermackay\"\n      }}>{`@rydermackay`}</a>{` pointed out to me that the Swift language is capturing the right-hand side of the conditional in a closure.`}</p>\n    <p>{`That is, given the conditional: `}<inlineCode parentName=\"p\">{`lhs && rhs`}</inlineCode>{` (“lhs” and “rhs” represent Left-Hand Side and Right-Hand Side respectively). `}<inlineCode parentName=\"p\">{`rhs`}</inlineCode>{` is being wrapped in a closure. More specifically, it is wrapped in an `}<inlineCode parentName=\"p\">{`autoclosure`}</inlineCode>{` so that it could lazily evaluate the right condition if the left condition was false.`}</p>\n    <p>{`This can be shown by looking at the source code for the `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/apple/swift/blob/7f105e4e3a994e6ac87860d5bd7bf9942c52b4bb/stdlib/public/core/Bool.swift#L289\"\n      }}>{`&& operator`}</a>{`:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-swift\"\n      }}>{`public static func && (lhs: Bool, rhs: @autoclosure () throws -> Bool) rethrows -> Bool {\n    return lhs ? try rhs() : false\n}\n`}</code></pre>\n    <p>{`In order to understand the warning a little better, we need to know what an `}<inlineCode parentName=\"p\">{`autoclosure`}</inlineCode>{` is.`}</p>\n    <p>{`From the Apple documentation, an `}<inlineCode parentName=\"p\">{`autoclosure`}</inlineCode>{`:`}</p>\n    <blockquote>\n      <p parentName=\"blockquote\">{`…is a closure that is automatically created to wrap an expression that’s being passed as an argument to a function. It doesn’t take any arguments, and when it’s called, it returns the value of the expression that’s wrapped inside of it.`}</p>\n    </blockquote>\n    <p>{`but most importantly:`}</p>\n    <blockquote>\n      <p parentName=\"blockquote\">{`An autoclosure lets you delay evaluation because the code inside isn’t run until you call the closure. Delaying evaluation is useful for code that has side effects or is computationally expensive because it lets you control when that code is evaluated.`}</p>\n    </blockquote>\n    <p>{`That means that the above `}<inlineCode parentName=\"p\">{`&&`}</inlineCode>{` implementation at a high level is equivalent to the following. Note: We can’t actually write `}<inlineCode parentName=\"p\">{`&&`}</inlineCode>{` without the `}<inlineCode parentName=\"p\">{`rhs`}</inlineCode>{` since it’s defined to have both parameters.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-swift\"\n      }}>{`// For simplicity, I've removed all throws\npublic static func && (lhs: Bool, rhs: () -> Bool) -> Bool {\n    return lhs ?? rhs()\n}\n\n// Example: Assume A and B are some boolean conditions\nA && { () -> Bool in\n    return B\n}\n`}</code></pre>\n    <p>{`If we update our previous `}<inlineCode parentName=\"p\">{`UserTheme`}</inlineCode>{` `}<inlineCode parentName=\"p\">{`init`}</inlineCode>{` with this re-interpretation, it would look like this`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-swift\"\n      }}>{`let result = self.user.isSubscribed && { () -> Bool in\n    return self.user.countryCode == \"CA\"\n}\nif result {\n    themeColor = self.user.themeColor\n}\n`}</code></pre>\n    <p>{`As you can see, the block captures `}<inlineCode parentName=\"p\">{`self.user.countryCode == \"CA\"`}</inlineCode>{` and since we’re doing this before `}<inlineCode parentName=\"p\">{`super.init()`}</inlineCode>{` when all members have initialized the compilation fails.`}</p>\n    <p>{`There are a few ways to fix this, we could:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`move all this offending code to below the `}<inlineCode parentName=\"li\">{`super.init()`}</inlineCode></li>\n      <li parentName=\"ul\">{`store the result of the right-hand side expression in a separate variable, or;`}</li>\n      <li parentName=\"ul\">{`we could move the creation of Themes to a `}<a parentName=\"li\" {...{\n          \"href\": \"https://en.wikipedia.org/wiki/Factory_method_pattern\"\n        }}>{`factory`}</a>{` class to avoid a `}<inlineCode parentName=\"li\">{`Theme`}</inlineCode>{` subclass`}</li>\n    </ul>\n    <p>{`Either way, these all work but in general you should typically avoid referencing `}<inlineCode parentName=\"p\">{`self`}</inlineCode>{` before the `}<inlineCode parentName=\"p\">{`super.init()`}</inlineCode>{` in cases like these.\nI hope you learned something and potentially got you interested in looking at more implementation details of the Swift programming language.`}</p>\n    <p>{`The sample code can be found `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/ajfigueroa/blog-code/tree/master/posts/3-Unexpected-Closure.playground\"\n      }}>{`here`}</a>{`.`}</p>\n    <h2 {...{\n      \"id\": \"additional-resources\"\n    }}>{`Additional Resources`}</h2>\n    <ul>\n      <li parentName=\"ul\"><a parentName=\"li\" {...{\n          \"href\": \"https://docs.swift.org/swift-book/LanguageGuide/Closures.html#ID543\"\n        }}>{`Autoclosure Documentation`}</a></li>\n      <li parentName=\"ul\"><a parentName=\"li\" {...{\n          \"href\": \"https://krakendev.io/blog/hipster-swift#autoclosure\"\n        }}>{`Hipster Swift post by KrakenDev`}</a></li>\n      <li parentName=\"ul\"><a parentName=\"li\" {...{\n          \"href\": \"https://github.com/apple/swift\"\n        }}>{`Swift Repo`}</a></li>\n    </ul>\n\n    </MDXLayout>;\n}\n\n;\nMDXContent.isMDXComponent = true;"}}